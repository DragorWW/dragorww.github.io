const a={MAX_FPS:60,MIN_FRAME_TIME:16.666666666666668,FONT_SIZE:30,FONT_FAMILY:"Fira Code, monospace",COLUMN_SPACING:.1,MAX_ACTIVE_COLUMNS_RATIO:1.55,SPAWN_RATE:.1,DESPAWN_RATE:.1,TRAIL_OPACITY:.15,MIN_SCROLL_OPACITY:.2,SYMBOL_UPDATE_RATE:.2},h={COLORS:{OPERATORS:"229, 192, 123",KEYWORDS:"198, 120, 221",FUNCTIONS:"97, 175, 239",STRINGS:"152, 195, 121",COMMENTS:"92, 99, 112",CONSTANTS:"224, 108, 117",BRACKETS:"209, 154, 102"},MIN_OPACITY:.4,MAX_OPACITY:.8,MIN_SPEED:.01,MAX_SPEED:.1},l={OPERATORS:[">=","<=","=>","->","<>","===","!==","||","&&","++","--"],KEYWORDS:["import","export","default","class","const","let","var","function","return","await","async"],FUNCTIONS:["try","catch","finally","break","continue","for","while","if","else","switch","case","do"],STRINGS:["...","?.","::"],COMMENTS:["<!--","-->","/**","*/","//","/*","*/"],CONSTANTS:["=>==","#!/"],BRACKETS:["[]","{}","()","<>","</>"]},n={PIXEL_SIZE:8,MIN_OPACITY:.02,MAX_OPACITY:.15,FADE_SPEED:.001,MAX_PIXELS:300,MOUSE_INFLUENCE_RADIUS:150,MOUSE_REPEL_STRENGTH:1,RETURN_SPEED:.05},c={light:{background:"rgba(255, 255, 255, 1)",pixelColor:"0, 0, 0",minOpacity:.05,maxOpacity:.25},dark:{background:"rgba(17, 17, 17, 1)",pixelColor:"255, 255, 255",minOpacity:.02,maxOpacity:.15}};class E{canvas;ctx;startDelay;mousePosition;currentTheme;isInitialized;pixels;themeObserver;lastTime;measureCanvas;measureCtx;maxCharWidth;columnWidth;columns;drops;activeColumns;opacities;speeds;currentSymbols;symbolUpdateCounters;isStatic;constructor(t){this.canvas=t,this.isStatic=this.canvas.classList.contains("static-canvas"),this.ctx=this.canvas.getContext("2d"),this.startDelay=Number(this.canvas.dataset.startDelay),this.mousePosition={x:-1e3,y:-1e3},this.currentTheme=document.documentElement.getAttribute("data-theme")||"dark",this.pixels=[],this.isInitialized=!1,this.setupCanvas(),this.setupBackground(),this.isStatic||this.bindEvents(),this.setupThemeObserver()}setupThemeObserver(){this.themeObserver=new MutationObserver(t=>{t.forEach(s=>{s.attributeName==="data-theme"&&(this.currentTheme=document.documentElement.getAttribute("data-theme")||"dark")})}),this.themeObserver.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]})}initialize(){this.isInitialized||(this.setupMeasureCanvas(),this.initializeArrays(),this.bindEvents(),this.lastTime=0,this.isInitialized=!0)}setupCanvas(){const t=this.canvas.parentElement;this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight}setupMeasureCanvas(){this.measureCanvas=document.createElement("canvas"),this.measureCtx=this.measureCanvas.getContext("2d"),this.measureCtx.font=`${a.FONT_SIZE}px ${a.FONT_FAMILY}`;const t=Object.values(l).flat();this.maxCharWidth=Math.max(...t.map(s=>this.measureCtx.measureText(s).width)),this.columnWidth=this.maxCharWidth+a.FONT_SIZE*a.COLUMN_SPACING}initializeArrays(){this.columns=Math.floor(this.canvas.width/this.columnWidth),this.drops=Array(this.columns).fill(1),this.activeColumns=new Set,this.opacities=Array(this.columns).fill(h.MAX_OPACITY),this.speeds=Array(this.columns).fill(1),this.currentSymbols=new Map,this.symbolUpdateCounters=new Map}bindEvents(){window.addEventListener("resize",()=>this.handleResize()),document.addEventListener("mousemove",t=>{const s=this.canvas.getBoundingClientRect();this.mousePosition={x:t.clientX-s.left,y:t.clientY-s.top+window.scrollY}}),document.addEventListener("mouseleave",()=>{this.mousePosition={x:-1e3,y:-1e3}})}handleResize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.setupBackground();const t=Math.floor(this.canvas.width/this.columnWidth);this.drops.length=t,this.opacities.length=t,this.speeds.length=t,this.drops.fill(1),this.opacities.fill(h.MAX_OPACITY),this.speeds.fill(1),this.activeColumns.clear(),this.currentSymbols.clear(),this.symbolUpdateCounters.clear()}draw(t){if(this.isStatic){this.lastTime=Math.random()*5555,this.ctx.fillStyle=c[this.currentTheme].background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<3;i++)this.spawnNewColumns(.2),this.spawnNewColumns(.4),this.spawnNewColumns(.6),this.spawnNewColumns(.8),this.spawnNewColumns(1);this.updateActiveColumns(),this.updatePixels();return}requestAnimationFrame(i=>this.draw(i)),!(t-this.lastTime<a.MIN_FRAME_TIME)&&(this.lastTime=t,this.ctx.fillStyle=c[this.currentTheme].background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.updatePixels(),this.spawnNewColumns(),this.updateActiveColumns())}isColumnAvailable(t){for(const i of this.activeColumns)if(Math.abs(Number(i)-t.x)<3)return!1;return!0}spawnNewColumns(t){if(this.isStatic?!0:this.activeColumns.size<this.columns*a.MAX_ACTIVE_COLUMNS_RATIO&&Math.random()>a.SPAWN_RATE){let i=10,e;do e={x:Math.floor(Math.random()*this.columns),chars:[],y:0,speed:0,length:0},i--;while((this.activeColumns.has(e.x)||!this.isStatic&&!this.isColumnAvailable(e))&&i>0);i>0&&!this.activeColumns.has(e.x)&&(this.activeColumns.add(e.x),this.drops[e.x]=t?Math.floor(this.canvas.height*t/a.FONT_SIZE):1,this.speeds[e.x]=this.isStatic?0:h.MIN_SPEED+Math.random()*(h.MAX_SPEED-h.MIN_SPEED),this.opacities[e.x]=h.MIN_OPACITY+Math.random()*(h.MAX_OPACITY-h.MIN_OPACITY))}}updateActiveColumns(){for(const t of this.activeColumns){if(!this.currentSymbols.has(t)||!this.symbolUpdateCounters.has(t)||Math.random()<a.SYMBOL_UPDATE_RATE){const o=Object.keys(l),r=o[Math.floor(Math.random()*o.length)],u=l[r],d=u[Math.floor(Math.random()*u.length)];this.currentSymbols.set(t,{text:d,category:r}),this.symbolUpdateCounters.set(t,0)}const{text:s,category:i}=this.currentSymbols.get(t),e=t*this.columnWidth+(this.columnWidth-this.measureCtx.measureText(s).width)/2;this.ctx.fillStyle=`rgba(${h.COLORS[i]}, ${this.opacities[t]})`,this.ctx.font=`${a.FONT_SIZE}px ${a.FONT_FAMILY}`,this.ctx.fillText(s,e,this.drops[t]*a.FONT_SIZE),this.symbolUpdateCounters.set(t,(this.symbolUpdateCounters.get(t)||0)+1),this.isStatic||this.drops[t]*a.FONT_SIZE>this.canvas.height&&(Math.random()>a.DESPAWN_RATE?(this.activeColumns.delete(t),this.drops[t]=1,this.speeds[t]=1,this.opacities[t]=h.MAX_OPACITY,this.currentSymbols.delete(t),this.symbolUpdateCounters.delete(t)):this.drops[t]=0),this.isStatic||(this.drops[t]+=this.speeds[t])}}setupBackground(){const t=c[this.currentTheme];this.pixels=Array(n.MAX_PIXELS).fill(null).map(()=>({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,originalX:Math.random()*this.canvas.width,originalY:Math.random()*this.canvas.height,size:n.PIXEL_SIZE+Math.random()*n.PIXEL_SIZE*2,opacity:t.minOpacity+Math.random()*(t.maxOpacity-t.minOpacity),fadeDirection:Math.random()>.5?1:-1}))}updatePixels(){const t=c[this.currentTheme];this.pixels.forEach(s=>{if(s.opacity+=n.FADE_SPEED*s.fadeDirection,(s.opacity<=t.minOpacity||s.opacity>=t.maxOpacity)&&(s.fadeDirection*=-1),this.mousePosition){const i=s.x-this.mousePosition.x,e=s.y-this.mousePosition.y,o=Math.sqrt(i*i+e*e);if(o<n.MOUSE_INFLUENCE_RADIUS){const r=(n.MOUSE_INFLUENCE_RADIUS-o)/n.MOUSE_INFLUENCE_RADIUS;s.x+=i/o*r*n.MOUSE_REPEL_STRENGTH,s.y+=e/o*r*n.MOUSE_REPEL_STRENGTH}}s.x+=(s.originalX-s.x)*n.RETURN_SPEED,s.y+=(s.originalY-s.y)*n.RETURN_SPEED,this.ctx.fillStyle=`rgba(${c[this.currentTheme].pixelColor}, ${s.opacity})`,this.ctx.fillRect(s.x,s.y,s.size,s.size)})}start(){this.startDelay?setTimeout(()=>{this.initialize(),this.isStatic?this.draw(0):requestAnimationFrame(t=>this.draw(t))},this.startDelay):(this.initialize(),this.isStatic?this.draw(0):requestAnimationFrame(t=>this.draw(t)))}destroy(){this.themeObserver.disconnect()}}document.querySelectorAll(".matrix-bg canvas").forEach(m=>{new E(m).start()});
