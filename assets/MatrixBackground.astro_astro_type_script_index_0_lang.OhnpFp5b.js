const l={LIGHT:"light",DARK:"dark"};function E(o){return o===l.LIGHT||o===l.DARK?o:l.DARK}(()=>{function o(s){document.querySelectorAll('link[rel="icon"]').forEach(c=>{c.setAttribute("media","none"),c.setAttribute("rel","icon")});const a=document.querySelector(`link[rel="icon"][data-theme="${s}"]`);a&&a.removeAttribute("media")}function t(){const s=document.documentElement,a=E(s.getAttribute("data-theme"))===l.LIGHT?l.DARK:l.LIGHT;s.setAttribute("data-theme",a),localStorage.setItem("theme",a),o(a)}function e(){const s=E(localStorage.getItem("theme"));document.documentElement.setAttribute("data-theme",s),o(s)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e):e(),window.toggleTheme=t})();function T(o){const e=o.currentTarget.dataset.lang;if(!e)return;localStorage.setItem("lang",e);const s=window.location.pathname,i=s.replace(/\/(ru|en)\//,`/${e}/`),a=i===s?`/${e}/`:i;window.location.href=a}document.querySelectorAll(".header__lang-btn").forEach(o=>{o.addEventListener("click",T)});const n={MAX_FPS:60,MIN_FRAME_TIME:1e3/60,FONT_SIZE:30,FONT_FAMILY:"Fira Code, monospace",COLUMN_SPACING:.1,MAX_ACTIVE_COLUMNS_RATIO:1.55,SPAWN_RATE:.1,DESPAWN_RATE:.1,TRAIL_OPACITY:.15,MIN_SCROLL_OPACITY:.2,SYMBOL_UPDATE_RATE:.2},r={COLORS:{OPERATORS:"229, 192, 123",KEYWORDS:"198, 120, 221",FUNCTIONS:"97, 175, 239",STRINGS:"152, 195, 121",COMMENTS:"92, 99, 112",CONSTANTS:"224, 108, 117",BRACKETS:"209, 154, 102"},MIN_OPACITY:.4,MAX_OPACITY:.8,MIN_SPEED:.01,MAX_SPEED:.1},u={OPERATORS:[">=","<=","=>","->","<>","===","!==","||","&&","++","--"],KEYWORDS:["import","export","default","class","const","let","var","function","return","await","async"],FUNCTIONS:["try","catch","finally","break","continue","for","while","if","else","switch","case","do"],STRINGS:["...","?.","::"],COMMENTS:["<!--","-->","/**","*/","//","/*","*/"],CONSTANTS:["=>==","#!/"],BRACKETS:["[]","{}","()","<>","</>"]},h={PIXEL_SIZE:8,MIN_OPACITY:.02,MAX_OPACITY:.15,FADE_SPEED:.001,MAX_PIXELS:300,MOUSE_INFLUENCE_RADIUS:150,MOUSE_REPEL_STRENGTH:1,RETURN_SPEED:.05},m={light:{background:"rgba(255, 255, 255, 1)",pixelColor:"0, 0, 0",minOpacity:.05,maxOpacity:.25},dark:{background:"rgba(17, 17, 17, 1)",pixelColor:"255, 255, 255",minOpacity:.02,maxOpacity:.15}};class A{canvas;ctx;startDelay;mousePosition;currentTheme;isInitialized;pixels;themeObserver;lastTime;measureCanvas;measureCtx;maxCharWidth;columnWidth;columns;drops;activeColumns;opacities;speeds;currentSymbols;symbolUpdateCounters;isStatic;constructor(t){this.canvas=t,this.isStatic=this.canvas.classList.contains("static-canvas"),this.ctx=this.canvas.getContext("2d"),this.startDelay=Number(this.canvas.dataset.startDelay),this.mousePosition={x:-1e3,y:-1e3},this.currentTheme=document.documentElement.getAttribute("data-theme")||"dark",this.pixels=[],this.isInitialized=!1,this.setupCanvas(),this.setupBackground(),this.isStatic||this.bindEvents(),this.setupThemeObserver()}setupThemeObserver(){this.themeObserver=new MutationObserver(t=>{t.forEach(e=>{e.attributeName==="data-theme"&&(this.currentTheme=document.documentElement.getAttribute("data-theme")||"dark")})}),this.themeObserver.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]})}initialize(){this.isInitialized||(this.setupMeasureCanvas(),this.initializeArrays(),this.bindEvents(),this.lastTime=0,this.isInitialized=!0)}setupCanvas(){const t=this.canvas.parentElement;this.canvas.width=t.clientWidth,this.canvas.height=t.clientHeight}setupMeasureCanvas(){this.measureCanvas=document.createElement("canvas"),this.measureCtx=this.measureCanvas.getContext("2d"),this.measureCtx.font=`${n.FONT_SIZE}px ${n.FONT_FAMILY}`;const t=Object.values(u).flat();this.maxCharWidth=Math.max(...t.map(e=>this.measureCtx.measureText(e).width)),this.columnWidth=this.maxCharWidth+n.FONT_SIZE*n.COLUMN_SPACING}initializeArrays(){this.columns=Math.floor(this.canvas.width/this.columnWidth),this.drops=Array(this.columns).fill(1),this.activeColumns=new Set,this.opacities=Array(this.columns).fill(r.MAX_OPACITY),this.speeds=Array(this.columns).fill(1),this.currentSymbols=new Map,this.symbolUpdateCounters=new Map}bindEvents(){window.addEventListener("resize",()=>this.handleResize()),document.addEventListener("mousemove",t=>{const e=this.canvas.getBoundingClientRect();this.mousePosition={x:t.clientX-e.left,y:t.clientY-e.top+window.scrollY}}),document.addEventListener("mouseleave",()=>{this.mousePosition={x:-1e3,y:-1e3}})}handleResize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.setupBackground();const t=Math.floor(this.canvas.width/this.columnWidth);this.drops.length=t,this.opacities.length=t,this.speeds.length=t,this.drops.fill(1),this.opacities.fill(r.MAX_OPACITY),this.speeds.fill(1),this.activeColumns.clear(),this.currentSymbols.clear(),this.symbolUpdateCounters.clear()}draw(t){if(this.isStatic){this.lastTime=Math.random()*5555,this.ctx.fillStyle=m[this.currentTheme].background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let s=0;s<3;s++)this.spawnNewColumns(.2),this.spawnNewColumns(.4),this.spawnNewColumns(.6),this.spawnNewColumns(.8),this.spawnNewColumns(1);this.updateActiveColumns(),this.updatePixels();return}requestAnimationFrame(s=>this.draw(s)),!(t-this.lastTime<n.MIN_FRAME_TIME)&&(this.lastTime=t,this.ctx.fillStyle=m[this.currentTheme].background,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.updatePixels(),this.spawnNewColumns(),this.updateActiveColumns())}isColumnAvailable(t){for(const s of this.activeColumns)if(Math.abs(Number(s)-t.x)<3)return!1;return!0}spawnNewColumns(t){if(this.isStatic?!0:this.activeColumns.size<this.columns*n.MAX_ACTIVE_COLUMNS_RATIO&&Math.random()>n.SPAWN_RATE){let s=10,i;do i={x:Math.floor(Math.random()*this.columns),chars:[],y:0,speed:0,length:0},s--;while((this.activeColumns.has(i.x)||!this.isStatic&&!this.isColumnAvailable(i))&&s>0);s>0&&!this.activeColumns.has(i.x)&&(this.activeColumns.add(i.x),this.drops[i.x]=t?Math.floor(this.canvas.height*t/n.FONT_SIZE):1,this.speeds[i.x]=this.isStatic?0:r.MIN_SPEED+Math.random()*(r.MAX_SPEED-r.MIN_SPEED),this.opacities[i.x]=r.MIN_OPACITY+Math.random()*(r.MAX_OPACITY-r.MIN_OPACITY))}}updateActiveColumns(){for(const t of this.activeColumns){if(!this.currentSymbols.has(t)||!this.symbolUpdateCounters.has(t)||Math.random()<n.SYMBOL_UPDATE_RATE){const a=Object.keys(u),c=a[Math.floor(Math.random()*a.length)],d=u[c],S=d[Math.floor(Math.random()*d.length)];this.currentSymbols.set(t,{text:S,category:c}),this.symbolUpdateCounters.set(t,0)}const{text:e,category:s}=this.currentSymbols.get(t),i=t*this.columnWidth+(this.columnWidth-this.measureCtx.measureText(e).width)/2;this.ctx.fillStyle=`rgba(${r.COLORS[s]}, ${this.opacities[t]})`,this.ctx.font=`${n.FONT_SIZE}px ${n.FONT_FAMILY}`,this.ctx.fillText(e,i,this.drops[t]*n.FONT_SIZE),this.symbolUpdateCounters.set(t,(this.symbolUpdateCounters.get(t)||0)+1),this.isStatic||this.drops[t]*n.FONT_SIZE>this.canvas.height&&(Math.random()>n.DESPAWN_RATE?(this.activeColumns.delete(t),this.drops[t]=1,this.speeds[t]=1,this.opacities[t]=r.MAX_OPACITY,this.currentSymbols.delete(t),this.symbolUpdateCounters.delete(t)):this.drops[t]=0),this.isStatic||(this.drops[t]+=this.speeds[t])}}setupBackground(){const t=m[this.currentTheme];this.pixels=Array(h.MAX_PIXELS).fill(null).map(()=>({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,originalX:Math.random()*this.canvas.width,originalY:Math.random()*this.canvas.height,size:h.PIXEL_SIZE+Math.random()*h.PIXEL_SIZE*2,opacity:t.minOpacity+Math.random()*(t.maxOpacity-t.minOpacity),fadeDirection:Math.random()>.5?1:-1}))}updatePixels(){const t=m[this.currentTheme];this.pixels.forEach(e=>{if(e.opacity+=h.FADE_SPEED*e.fadeDirection,(e.opacity<=t.minOpacity||e.opacity>=t.maxOpacity)&&(e.fadeDirection*=-1),this.mousePosition){const s=e.x-this.mousePosition.x,i=e.y-this.mousePosition.y,a=Math.sqrt(s*s+i*i);if(a<h.MOUSE_INFLUENCE_RADIUS){const c=(h.MOUSE_INFLUENCE_RADIUS-a)/h.MOUSE_INFLUENCE_RADIUS;e.x+=s/a*c*h.MOUSE_REPEL_STRENGTH,e.y+=i/a*c*h.MOUSE_REPEL_STRENGTH}}e.x+=(e.originalX-e.x)*h.RETURN_SPEED,e.y+=(e.originalY-e.y)*h.RETURN_SPEED,this.ctx.fillStyle=`rgba(${m[this.currentTheme].pixelColor}, ${e.opacity})`,this.ctx.fillRect(e.x,e.y,e.size,e.size)})}start(){this.startDelay?setTimeout(()=>{this.initialize(),this.isStatic?this.draw(0):requestAnimationFrame(t=>this.draw(t))},this.startDelay):(this.initialize(),this.isStatic?this.draw(0):requestAnimationFrame(t=>this.draw(t)))}destroy(){this.themeObserver.disconnect()}}document.querySelectorAll(".matrix-bg canvas").forEach(o=>{new A(o).start()});
